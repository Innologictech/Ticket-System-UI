<div class="card-header">
    Tickets List
</div>


<div class="mb-3 d-flex justify-content-between">
    <input type="text" class=" w-15" style="margin-top: 1rem;" placeholder="Search..." [(ngModel)]="searchText" />
</div>

<div class="table-responsive tableFixHead">
    <table class="table table-bordered table-hover bg-white">
        <thead class="table-dark text-center">
            <tr>
                <th (click)="setSort('customerticketId')" style="cursor:pointer">
                    Ticket Id
                </th>
                <th (click)="setSort('title')" style="cursor:pointer">Title</th>
                <th (click)="setSort('priority')" style="cursor:pointer">Priority</th>
                <th (click)="setSort('status')" style="cursor:pointer">Status</th>
                <th (click)="setSort('date')" style="cursor:pointer">Created Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let ticket of sortedTickets
            | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage }
        " class="">
                <td>{{ ticket.customerticketId }}</td>
                <td>{{ ticket.title }}</td>
                <!-- <td>{{ ticket.priority }}

                </td> -->
                <td>
                    <span *ngIf="ticket.priority === 'High'">
                        {{ticket.priority}}
                        <i class="fas fa-arrow-up text-danger"></i>
                    </span>
                    <span *ngIf="ticket.priority === 'Medium'">
                        {{ticket.priority}}
                        <i class="fas fa-minus text-warning"></i>
                    </span>
                    <span *ngIf="ticket.priority === 'Low'">
                        {{ticket.priority}}
                        <i class="fas fa-arrow-down text-success"></i>
                    </span>
                </td>

                <td>

                    {{ ticket.status }}

                </td>
                <td>{{ ticket.date | date: 'dd-MM-yyyy' }}</td>
                <td class="text-center">
                    <!-- View Button -->
                    <button class="btn btn-sm btn-info me-2" (click)="viewTicketModel(ticket, createBugTicketTemplate)">
                        View
                    </button>

                    <!-- Edit Button -->
                    <button class="btn btn-sm btn-warning me-2"
                        (click)="editTicketModel(ticket, createBugTicketTemplate)">
                        Edit
                    </button>

                    <!-- Reject Button -->
                    <!-- <button class="btn btn-sm btn-danger" (click)="onRejectTicket(ticket) "
                        *ngIf="ticket.status !== 'Rejected'">
                        Reject
                    </button> -->
                </td>


            </tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-end mt-3">
    <pagination-controls (pageChange)="currentPage = $event"
        class="pagination justify-content-end"></pagination-controls>
</div>

<ng-template #createBugTicketTemplate let-c="close">
    <div class="modal-body">
        <form [formGroup]="bugTicketForm" autocomplete="off">
            <div class="row">

                <!-- Title (Read-only) -->
                <div class="col-md-6">
                    <label>Title</label>
                    <input class="form-control" formControlName="title" type="text" readonly />
                </div>

                <!-- Reported By (Read-only) -->
                <div class="col-md-6">
                    <label>Reported By</label>
                    <input class="form-control" formControlName="reportedBy" type="text" readonly />
                </div>

                <!-- Priority (Read-only) -->
                <div class="col-md-6">
                    <label>Priority</label>
                    <!-- <select *ngIf="isEditMode" class="form-control" formControlName="priority" >
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select> -->
                    <input class="form-control" formControlName="priority" type="text" readonly />

                </div>

                <!-- Environment (Read-only) -->
                <div class="col-md-6">
                    <label>Environment</label>
                    <!-- <select *ngIf="isEditMode" class="form-control" formControlName="environment">
                        <option value="Development">Development</option>
                        <option value="Quality">Quality</option>
                        <option value="Production">Production</option>
                    </select> -->
                    <input class="form-control" formControlName="environment" type="text" readonly />

                </div>

                <!-- Status (Read-only) -->
                <!-- <div class="col-md-6">
                    <label>Status</label>
                    <input class="form-control" formControlName="ticketstatus" type="text"   />
                </div> -->
                <!-- ... (previous HTML remains the same until the Status field) -->

                <!-- Status Field - Different display based on mode -->
                <div class="col-md-6">
                    <label>Status</label>
                    <!-- Show dropdown in edit mode -->
                    <select *ngIf="isEditMode" class="form-control" formControlName="ticketstatus">
                        <!-- @for (status of statusOptions;track status){
        <option  [value]="status">{{status}}</option>

        } -->
                        <option [value]=""></option>
                        <option *ngFor="let status of allStatus" [value]="status.status">{{status.label}}</option>
                    </select>
                    <!-- Show readonly input in create mode -->
                    <input *ngIf="!isEditMode" class="form-control" formControlName="ticketstatus" type="text"
                        readonly />
                </div>

                <!-- ... (rest of the HTML remains the same) -->

                <!-- Date (Read-only) -->
                <div class="col-md-6">
                    <label>Date</label>
                    <input class="form-control" formControlName="date" type="date" readonly />
                </div>

                <!-- Description (Read-only) -->
                <div class="col-md-12">
                    <label>Description</label>
                    <textarea class="form-control" formControlName="description" rows="4" readonly></textarea>
                </div>

                <!-- Assigned To  -->
                <div class="col-md-12">
                    <label>Assigned To<span class="text-danger">*</span></label>
                    <select *ngIf="isEditMode" class="form-control" formControlName="assignedTo">
                        <option value="" disabled selected hidden>Select Assignee</option>
                        <option *ngFor="let user of userList" [value]="user.userName">
                            {{ user.userName }}
                        </option>
                    </select>
                    <input *ngIf="!isEditMode" class="form-control" formControlName="assignedTo" type="text" readonly />

                </div>



                <!-- Attachment -->

                <div *ngIf="!isEditMode" class="col-md-12">
                    <label>Attachments</label>
                    <input class="form-control" formControlName="attachments" type="file" [readonly]="isViewMode"
                        accept=".pdf" (change)="onFileSelected($event,'attachments')" />
                </div>


                <!-- Attachment (Edit mode only) -->
                <div class="col-md-12" *ngIf="isEditMode">
                    <label>Attachment</label><br>

                    <!-- Show existing PDF preview if available and not removed -->
                    <div
                        *ngIf="selectedTicket?.attachment?.contentType === 'application/pdf' && !attachmentRemoved; else uploadNew">
                        <div class="pdf-preview" (click)="viewPdf(selectedTicket.attachment)">
                            <i class="fa fa-file-pdf-o pdf-icon"></i>
                            <span>{{ selectedTicket.attachment.filename }}</span>
                        </div>
                        <span class="remove-icon" (click)="removeAttachment()">&times;</span>
                    </div>

                    <!-- File input for uploading a new attachment (shown after removing) -->
                    <ng-template #uploadNew>
                        <input type="file" class="form-control" formControlName="attachments" [readonly]="isViewMode"
                            accept=".pdf" (change)="onFileSelected($event, 'attachments')" />
                    </ng-template>
                </div>

                <!-- PDF Fullscreen Viewer -->
                <div class="fullscreen-overlay" *ngIf="isPdfFullScreen" (click)="closeFullPdf()">
                    <div class="fullscreen-pdf" (click)="$event.stopPropagation()">
                        <iframe [src]="selectedPdfUrl" width="100%" height="100%"></iframe>
                        <button class="close-btn" (click)="closeFullPdf()">âœ–</button>
                    </div>
                </div>



               

                <div *ngIf="isEditMode" class="col-md-12">
                    <label>Upload</label>
                    <input class="form-control" formControlName="upload" type="file" accept=".pdf"
                        [readonly]="isViewMode" (change)="onFileSelected($event,'upload')" />
                </div>


            </div>
        </form>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="UpdateTicket()" *ngIf="isEditMode">Submit</button>
        <button type="button" class="btn btn-secondary" (click)="c('Close click')">Close</button>
    </div>
</ng-template>