<div class="">
    <form>

        <div class="card">
            <div class="card-header">
                My Tickets
            </div>
            <div class="card-body">

                <div class="textRight">
                    <button type="button" class="btn btn-raised btn-md btnSubmitApproval"
                        (click)="TicketCreationModel(createBugTicketTemplate)">
                        Create New Ticket
                    </button>
                </div>

                <div class="table-responsive tableFixHead">
                    <table class="table table-bordered table-hover bg-white">
                        <thead class="table-dark text-center">
                            <tr>
                                <th>Ticket Id</th>
                                <th>Title</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let ticket of tickets$ | async" class="align-middle">
                                <td>{{ ticket.customerticketId }}</td>
                                <td>{{ ticket.title }}</td>
                                <td>


                                    {{ ticket.priority }}

                                </td>
                                <td>

                                    {{ ticket.status }}

                                </td>
                                <td>{{ ticket.date | date: 'dd-MM-yyyy' }}</td>
                                <td class="text-center">
                                    <i class="fa fa-eye text-info me-2" (click)="viewTicket(ticket, createBugTicketTemplate)"></i>
                                    <i class="fa fa-edit text-warning me-2"
                                        (click)="editTicketModel(ticket, createBugTicketTemplate)"></i>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>


            </div>

        </div>


    </form>

</div>
<ng-template #createBugTicketTemplate let-c="close">
    <div class="modal-header">
        Raise New Ticket
    </div>

    <div class="modal-body">
        <form [formGroup]="bugTicketForm" autocomplete="off">
            <div class="row">

                <!-- Title -->
                <div class="col-md-6">
                    <label>Title<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="title" type="text" placeholder="Enter Title" [readonly]="isViewMode" />
                    <div class="text-danger" *ngIf="submit && f['title'].errors?.['required']">
                        Title is required.
                    </div>
                </div>

                <!-- Reported By -->
                <div class="col-md-6">
                    <label>Reported By<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="reportedBy" type="text"
                        placeholder="Enter Reporter Name" readonly  [readonly]="isViewMode"/>
                    <div class="text-danger" *ngIf="submit && f['reportedBy'].errors?.['required']">
                        Reported By is required.
                    </div>
                </div>

                <!-- Priority -->
                <div class="col-md-6">
                    <label>Priority<span class="text-danger">*</span></label>
                    <select class="form-control" formControlName="priority" [disabled]="isViewMode">
                        <option value="" disabled hidden>Select Priority</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <!-- <option value="Critical">Critical</option> -->
                    </select>
                    <div class="text-danger" *ngIf="submit && f['priority'].errors?.['required']">
                        Priority is required.
                    </div>
                </div>

                <!-- Environment -->
                <div class="col-md-6">
                    <label>Environment<span class="text-danger">*</span></label>
                    <select class="form-control" formControlName="environment" [disabled]="isViewMode">
                        <option value="" disabled hidden>Select</option>
                        <option value="Development">Development</option>
                        <option value="Quality">Quality</option>
                        <option value="Production">Production</option>
                    </select>
                    <div class="text-danger" *ngIf="submit && f['environment'].errors?.['required']">
                        Environment is required.
                    </div>
                </div>

                <!-- Issue Type-->
                <div class="col-md-6">
                    <label>Issue Type<span class="text-danger">*</span></label>
                    <select class="form-control" formControlName="issueType" [disabled]="isViewMode">
                        <option value="" disabled hidden>Select</option>
                        <option value="bug">Bug</option>
                        <option value="enhancement">Enhancement</option>
                        <option value="technicalIssue">Technical Issue</option>
                        <option value="other">Other</option>
                    </select>
                    <div class="text-danger" *ngIf="submit && f['issueType'].errors?.['required']">
                        Environment is required.
                    </div>
                </div>

                <!-- Status (readonly) -->
                <!-- <div class="col-md-6">
                <label>Status</label>
                <input class="form-control" formControlName="ticketstatus" value="open" type="text" readonly />
            </div> -->
                <!-- ... (previous HTML remains the same until the Status field) -->

                <!-- Status Field - Different display based on mode -->
                <div class="col-md-6">
                    <label>Status</label>
                    <!-- Show dropdown in edit mode -->
                    <select *ngIf="isEditMode" class="form-control" formControlName="ticketstatus" [disabled]="isViewMode">
                        <option *ngFor="let status of statusOptions" [value]="status">{{status}}</option>
                    </select>
                    <!-- Show readonly input in create mode -->
                    <input *ngIf="!isEditMode" class="form-control" formControlName="ticketstatus" type="text"
                        readonly [readonly]="isViewMode"/>
                </div>



                <!-- Date -->
                <div class="col-md-6">
                    <label>Date<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="date" type="date" [readonly]="isViewMode"/>
                    <div class="text-danger" *ngIf="submit && f['date'].errors?.['required']">
                        Date is required.
                    </div>
                </div>

                <!-- Description -->
                <div class="col-md-12">
                    <label>Description<span class="text-danger">*</span></label>
                    <textarea class="form-control" formControlName="description" rows="4"
                        placeholder="Describe the issue..."></textarea>
                    <div class="text-danger" *ngIf="submit && f['description'].errors?.['required']">
                        Description is required.
                    </div>
                </div>

                <!-- Attachment -->
                <div *ngIf="!isEditMode" class="col-md-12">
                    <label>Attachments</label>
                    <input class="form-control" formControlName="attachments" type="file" [readonly]="isViewMode"
                        (change)="onFileSelected($event,'attachments')" />
                </div>

                <!-- <div   class="col-md-12" *ngIf="isEditMode && selectedTicket?.attachment?.contentType?.startsWith('image/')">
                    <label>Attachment</label><br>
                    <img [src]="getAttachmentUrl(selectedTicket)" [alt]="selectedTicket?.attachment?.filename"
                        style="max-width:50%; max-height:20%; object-fit:contain; border: 1px solid #ddd; padding: 5px;" />
                </div> -->

                <!-- <div class="col-md-12"
                    *ngIf="isEditMode && selectedTicket?.attachment?.contentType?.startsWith('image/')">
                    <label>Attachment</label><br>
                    <img [src]="getAttachmentUrl(selectedTicket)" [alt]="selectedTicket?.attachment?.filename"
                        style="max-width:80%; max-height:40%; object-fit:contain; border:1px solid #ddd; padding:5px; cursor:pointer;"
                        (click)="viewFullImage(getAttachmentUrl(selectedTicket))" />
                </div> -->

                <div class="col-md-12" *ngIf="isEditMode">

                    <label>Attachment</label><br>
                    <div class="image-container"
                        *ngIf="selectedTicket?.attachment?.startsWith('data:image'); else uploadNew">

                        <img [src]="selectedTicket.attachment" alt="Attachment"
                            (click)="viewFullImage(selectedTicket.attachment)" />

                        <span class="remove-icon" (click)="removeAttachment()">&times;</span>
                    </div>

                    

                    <!-- File Upload (Shown when no attachment) -->
                    <ng-template #uploadNew>

                        <input type="file" class="form-control" formControlName="attachments" [readonly]="isViewMode"
                            (change)="onFileSelected($event,'attachments')" />
                    </ng-template>
                </div>


                <!-- Overlay -->
                <div class="fullscreen-image" *ngIf="isImageFullScreen" (click)="closeFullImage()">
                    <img [src]="selectedImageUrl" [alt]="selectedTicket?.attachment?.filename">
                </div>


                <div *ngIf="isEditMode" class="col-md-12">
                    <label>Upload</label>
                    <input class="form-control" formControlName="upload" type="file" [readonly]="isViewMode"
                        (change)="onFileSelected($event,'upload')" />
                </div>

            </div>
        </form>
    </div>


    <div class="modal-footer">
        <button *ngIf="!isEditMode && !isViewMode" class="btn btn-primary" (click)="CreateTicket()">Submit</button>
        <button *ngIf="isEditMode && !isViewMode" class="btn btn-warning" (click)="updateTicket()">Update</button>
        <!-- <button type="button" class="btn btn-secondary" (click)="c('Close click')">Close</button> -->
        <button type="button" class="btn btn-secondary" (click)="closeModal('Close click')">Close</button>

    </div>
</ng-template>