<div class="">
    <form>

        <div class="card">
            <div class="card-header">
                My Tickets
            </div>
            <div class="card-body">

                <div class="textRight">
                    <button type="button" class="btn btn-raised btn-md btnSubmitApproval"
                        (click)="TicketCreationModel(createBugTicketTemplate)">
                        Create New Ticket
                    </button>
                </div>

                <div class="mb-3 d-flex justify-content-between">
                    <input type="text" class="w-15" style="margin-top: 1rem;" placeholder="Search..."
                        [(ngModel)]="searchText" (ngModelChange)="applySearchFilter()" name="searchText" />
                </div>

                <div class="table-responsive tableFixHead">
                    <table class="table table-bordered table-hover bg-white">
                        <thead class="table-dark text-center">
                            <tr>
                                <th>Ticket Id</th>
                                <th>Issue Short Description</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- <tr *ngFor="let ticket of tickets$ | async" class="align-middle"> -->
                            <tr
                                *ngFor="let ticket of ticketList | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage }">

                                <td>{{ ticket.customerticketId }}</td>
                                <td>{{ ticket.title }}</td>
                                <td>


                                    {{ ticket.priority }}

                                </td>
                                <td>

                                    {{ ticket.status }}

                                </td>
                                <td>{{ ticket.date | date: 'dd-MM-yyyy' }}</td>
                                <td class="text-center">
                                    <i class="fa fa-eye text-info me-2"
                                        (click)="viewTicket(ticket, createBugTicketTemplate)"></i>
                                    <i class="fa fa-edit text-warning me-2"
                                        (click)="editTicketModel(ticket, createBugTicketTemplate)"></i>
                                </td>
                            </tr>
                            @if ((tickets$ | async)?.length ===0){
                            <tr>
                                <td colspan="6" class="text-center text-danger">Data not Available</td>
                            </tr>}
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <pagination-controls (pageChange)="currentPage = $event"
                        class="pagination justify-content-end"></pagination-controls>
                </div>



            </div>

        </div>


    </form>

</div>
<ng-template #createBugTicketTemplate let-c="close">
    <div class="modal-header">
        {{ modalTitle }}
    </div>


    <div class="modal-body">
        <form [formGroup]="bugTicketForm" autocomplete="off">
            <div class="row">

                <!-- Title -->
                <!-- <div class="col-md-6">
                    <label>Issue Short Description<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="title" type="text" placeholder="Enter Title"
                        [readonly]="isViewMode" />
                    <div class="text-danger" *ngIf="submit && f['title'].errors?.['required']">
                        Issue short Description is required.
                    </div>
                </div> -->
                <div class="col-md-6">
                    <label>Issue Short Description<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="title" type="text" placeholder="Enter Title"
                        [readonly]="isViewMode || isEditMode" /> <!-- Added isEditMode condition -->
                    <div class="text-danger" *ngIf="submit && f['title'].errors?.['required']">
                        Issue short Description is required.
                    </div>
                </div>

                <!-- Reported By -->
                <!-- <div class="col-md-6">
                    <label>Reported By<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="reportedBy" type="text"
                        placeholder="Enter Reporter Name" readonly [readonly]="isViewMode" />
                    <div class="text-danger" *ngIf="submit && f['reportedBy'].errors?.['required']">
                        Reported By is required.
                    </div>
                </div> -->
                <!-- <div class="col-md-6">
                    <label>Reported By<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="reportedBy" type="text"
                        placeholder="Enter Reporter Name" readonly [readonly]="isViewMode || isEditMode" />  
                    <div class="text-danger" *ngIf="submit && f['reportedBy'].errors?.['required']">
                        Reported By is required.
                    </div>
                </div> -->
                <div class="col-md-6">
                    <label>Reported By<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="reportedBy" type="text"
                        placeholder="Enter Reporter Name" readonly />
                    <div class="text-danger" *ngIf="submit && f['reportedBy'].errors?.['required']">
                        Reported By is required.
                    </div>
                </div>


                <!-- Priority -->
                <div class="col-md-6">
                    <label>Priority<span class="text-danger">*</span></label>
                    <select class="form-control" formControlName="priority" [disabled]="isViewMode">
                        <option value="" disabled hidden>Select Priority</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <!-- <option value="Critical">Critical</option> -->
                    </select>
                    <div class="text-danger" *ngIf="submit && f['priority'].errors?.['required']">
                        Priority is required.
                    </div>
                </div>

                <!-- Environment -->
                <div class="col-md-6">
                    <label>Environment<span class="text-danger">*</span></label>
                    <select class="form-control" formControlName="environment" [disabled]="isViewMode">
                        <option value="" disabled hidden>Select</option>
                        <option value="Development">Development</option>
                        <option value="Quality">Quality</option>
                        <option value="Production">Production</option>
                    </select>
                    <div class="text-danger" *ngIf="submit && f['environment'].errors?.['required']">
                        Environment is required.
                    </div>
                </div>

                <!-- Issue Type-->
                <div class="col-md-6">
                    <label>Issue Type<span class="text-danger">*</span></label>
                    <select class="form-control" formControlName="issueType" [disabled]="isViewMode">
                        <option value="" disabled hidden>Select</option>
                        <option value="serviceRequest">Service Request</option>
                        <option value="serviceRestoration">Service Restoration</option>
                        <option value="miniProject">Mini Project</option>
                        <!-- <option value="other">Other</option> -->
                    </select>
                    <div class="text-danger" *ngIf="submit && f['issueType'].errors?.['required']">
                        Environment is required.
                    </div>
                </div>

                <!-- Status (readonly) -->
                <!-- <div class="col-md-6">
                <label>Status</label>
                <input class="form-control" formControlName="ticketstatus" value="open" type="text" readonly />
            </div> -->
                <!-- ... (previous HTML remains the same until the Status field) -->

                <!-- Status Field - Different display based on mode -->
                <div class="col-md-6">
                    <label>Status</label>
                    <!-- Show dropdown in edit mode -->
                    <select *ngIf="isEditMode" class="form-control" formControlName="ticketstatus"
                        [disabled]="isViewMode">
                        <option [value]="">select</option>
                        <!-- <option *ngFor="let status of allStatus" [value]="status.status">{{status.label}}</option> -->
                        <option *ngFor="let status of allStatus" [value]="status.status">{{status.label}}</option>

                    </select>
                    <!-- Show readonly input in create mode -->
                    <input *ngIf="!isEditMode" class="form-control" formControlName="ticketstatus" type="text"
                        readonly />
                </div>



                <!-- Date -->
                <!-- <div class="col-md-6">
                    <label>Date&Time<span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="date" type="date" [readonly]="isViewMode" />
                    <div class="text-danger" *ngIf="submit && f['date'].errors?.['required']">
                        Date is required.
                    </div>
                </div> -->
                <div class="col-md-6">
                    <label>Date&Time<span class="text-danger">*</span></label>
                    <!-- <input class="form-control" formControlName="date" type="datetime-local" 
                        readonly />   -->
                    <input class="form-control" formControlName="date" type="datetime-local" [readonly]="true" />
                    <div class="text-danger" *ngIf="submit && f['date'].errors?.['required']">
                        Date and time is required.
                    </div>
                </div>

                <!-- Description -->
                <div class="col-md-12">
                    <label>Description<span class="text-danger">*</span></label>
                    <textarea class="form-control" formControlName="description" rows="4"
                        placeholder="Describe the issue..."></textarea>
                    <div class="text-danger" *ngIf="submit && f['description'].errors?.['required']">
                        Description is required.
                    </div>
                </div>

                <!-- Attachment -->

                <div *ngIf="!isEditMode" class="col-md-12">
                    <label>Attachments</label>
                    <input class="form-control" formControlName="attachments" type="file" [readonly]="isViewMode"
                        accept=".pdf" (change)="onFileSelected($event,'attachments')" />
                </div>


                <!-- Attachment (Edit mode only) -->
                <div class="col-md-12" *ngIf="isEditMode">
                    <label>Attachment</label><br>

                    <!-- Show existing PDF preview if available and not removed -->
                    <div
                        *ngIf="selectedTicket?.attachment?.contentType === 'application/pdf' && !attachmentRemoved; else uploadNew">
                        <div class="pdf-preview" (click)="viewPdf(selectedTicket.attachment)">
                            <i class="fa fa-file-pdf-o pdf-icon"></i>
                            <span>{{ selectedTicket.attachment.filename }}</span>
                        </div>
                        <span class="remove-icon" (click)="removeAttachment()">&times;</span>
                    </div>

                    <!-- File input for uploading a new attachment (shown after removing) -->
                    <ng-template #uploadNew>
                        <input type="file" class="form-control" formControlName="attachments" [readonly]="isViewMode"
                            accept=".pdf" (change)="onFileSelected($event, 'attachments')" />
                    </ng-template>
                </div>

               <!-- PDF Fullscreen Viewer -->
<div class="fullscreen-overlay" *ngIf="isPdfFullScreen" (click)="closeFullPdf()">
  <div class="fullscreen-pdf" (click)="$event.stopPropagation()">
    <iframe [src]="selectedPdfUrl" width="100%" height="100%"></iframe>
    <button class="close-btn" (click)="closeFullPdf()">âœ–</button>
  </div>
</div>


                <!-- Overlay -->
                <!-- <div class="fullscreen-image" *ngIf="isImageFullScreen" (click)="closeFullImage()">
                    <img [src]="selectedImageUrl" [alt]="selectedTicket?.attachment?.filename">
                </div> -->




            </div>
        </form>
    </div>


    <div class="modal-footer">
        <button *ngIf="!isEditMode && !isViewMode" class="btn btn-primary" (click)="CreateTicket()">Submit</button>
        <button *ngIf="isEditMode && !isViewMode" class="btn btn-warning" (click)="updateTicket()">Update</button>
        <!-- <button type="button" class="btn btn-secondary" (click)="c('Close click')">Close</button> -->
        <button type="button" class="btn btn-secondary" (click)="closeModal('Close click')">Close</button>

    </div>
</ng-template>